<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <style>
            h1 {text-align: center;}
        </style>
        <title>Book Recommender</title>
    </head>
    <body>
        <h1>Book Recommender</h1> 
        <label for="site-search">Enter a book to find your next read...:</label>
        
        <input type="search" id="site-search" name="q" />
        
        <input type="submit" id="button" name="button" value="Enter" />
        <!-- create a display element for query and backend reponse-->
        <!-- <div id="book_query"></div> -->
        <div id="backend_response"></div>

        <!-- main javascript function -->
        <script>
            // declare as block scoped so accessible by other functions
            let socket; 

            // initiate websocket communication with backend
            function initialise_websocket(){
                // add backend url
                socket = new WebSocket('ws://localhost:8000/ws');

                // use socket onmessage to call/display backend response
                socket.onopen = function (event) {
                    // log that user is connected to socket
                    console.log('connected to socket!');
                }
                // log when a message is received from server
                socket.onmessage = function (event) {
                    // need to get/store server response
                    const response = document.getElementById('backend_response');

                    try {
                            // parse JSON string to JavaScript array
                            const recommendations = JSON.parse(event.data);

                            // display recommendations as an unordered list
                            response.innerHTML = `
                                <ul>
                                    ${recommendations.map(book => `<li><a href="${getGoodreadsUrl(book)}" target="_blank" rel="noopener noreferrer">${book}</a></li>`).join('')}
                                </ul>
                            `;
                    } catch (error) {
                        console.error('Error parsing server response:', error);
                        response.innerText = 'Failed to load recommendations.';
                    }

                    console.log('message received!', event.data)
                }

                // WebSocket connection is closed
                socket.onclose = function (event) {
                    // Log a message when disconnected from the WebSocket server
                    console.log('Disconnected from WebSocket server');

                }
            
            }

            function main() {
                document.getElementById('button').onclick = function () {
                    var input = document.getElementById('site-search');
                    
                    // displays query (input) value (this can be commented out tbf)
                    // document.getElementById("book_query").innerText = input.value;

                    const query = input.value;

                    // send query to backend
                    sendQuery(query);

                };
            }

            // function to send book query to backend server
            function sendQuery(query) {
                // send query 
                socket.send(query);
            }

            // function to generate goodreads url for each recommended book
            function getGoodreadsUrl(book_name) {
                // encode book in correct format for url
                const cleanTitle = book_name.replace(/\(.*?\)/g, '').trim();
                return `https://www.goodreads.com/search?query=${encodeURIComponent(cleanTitle.trim())}`;
            }

            // call main function
            initialise_websocket();
            main();
        </script>
    </body>
</html>